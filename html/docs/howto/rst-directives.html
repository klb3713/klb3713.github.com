
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Creating reStructuredText Directives &mdash; klb3713&#39;s notebook</title>
    
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="klb3713&#39;s notebook" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../index.html">klb3713&#39;s notebook</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="creating-restructuredtext-directives">
<h1>Creating <a class="reference external" href="http://docutils.sourceforge.net/rst.html">reStructuredText</a> Directives<a class="headerlink" href="#creating-restructuredtext-directives" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Authors:</th><td class="field-body">Dethe Elza, David Goodger, Lea Wiemann</td>
</tr>
<tr class="field-even field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:docutils-develop&#37;&#52;&#48;lists&#46;sourceforge&#46;net">docutils-develop<span>&#64;</span>lists<span>&#46;</span>sourceforge<span>&#46;</span>net</a></td>
</tr>
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">$Date: 2012-01-03 20:23:53 +0100 (Di, 03. Jan 2012) $</td>
</tr>
<tr class="field-even field"><th class="field-name">Revision:</th><td class="field-body">$Revision: 7302 $</td>
</tr>
<tr class="field-odd field"><th class="field-name">Copyright:</th><td class="field-body">This document has been placed in the public domain.</td>
</tr>
</tbody>
</table>
<p>Directives are the primary extension mechanism of reStructuredText.
This document aims to make the creation of new directives as easy and
understandable as possible.  There are only a couple of
reStructuredText-specific features the developer needs to know to
create a basic directive.</p>
<p>The syntax of directives is detailed in the <a class="reference external" href="../ref/rst/restructuredtext.html#directives">reStructuredText Markup
Specification</a>, and standard directives are described in
<a class="reference external" href="../ref/rst/directives.html">reStructuredText Directives</a>.</p>
<p>Directives are a reStructuredText markup/parser concept.  There is no
&#8220;directive&#8221; document tree element, no single element that corresponds
exactly to the concept of directives.  Instead, choose the most
appropriate elements from the existing Docutils elements.  Directives
build structures using the existing building blocks.  See <a class="reference external" href="../ref/doctree.html">The
Docutils Document Tree</a> and the <tt class="docutils literal"><span class="pre">docutils.nodes</span></tt> module for more
about the building blocks of Docutils documents.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#creating-restructuredtext-directives" id="id4">Creating reStructuredText Directives</a><ul>
<li><a class="reference internal" href="#the-directive-class" id="id5">The Directive Class</a></li>
<li><a class="reference internal" href="#option-conversion-functions" id="id6">Option Conversion Functions</a></li>
<li><a class="reference internal" href="#error-handling" id="id7">Error Handling</a></li>
<li><a class="reference internal" href="#register-the-directive" id="id8">Register the Directive</a></li>
<li><a class="reference internal" href="#examples" id="id9">Examples</a><ul>
<li><a class="reference internal" href="#admonitions" id="id10">Admonitions</a></li>
<li><a class="reference internal" href="#image" id="id11">&#8220;image&#8221;</a></li>
<li><a class="reference internal" href="#the-pending-element" id="id12">The Pending Element</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="the-directive-class">
<h2><a class="toc-backref" href="#id5">The Directive Class</a><a class="headerlink" href="#the-directive-class" title="Permalink to this headline">¶</a></h2>
<p>Directives are created by defining a directive class that inherits
from <tt class="docutils literal"><span class="pre">docutils.parsers.rst.Directive</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">docutils.parsers</span> <span class="kn">import</span> <span class="n">rst</span>

<span class="k">class</span> <span class="nc">MyDirective</span><span class="p">(</span><span class="n">rst</span><span class="o">.</span><span class="n">Directive</span><span class="p">):</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>To understand how to implement the directive, let&#8217;s have a look at the
docstring of the <tt class="docutils literal"><span class="pre">Directive</span></tt> base class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">docutils.parsers</span> <span class="kn">import</span> <span class="n">rst</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">rst</span><span class="o">.</span><span class="n">Directive</span><span class="o">.</span><span class="n">__doc__</span>

<span class="go">    Base class for reStructuredText directives.</span>

<span class="go">    The following attributes may be set by subclasses.  They are</span>
<span class="go">    interpreted by the directive parser (which runs the directive</span>
<span class="go">    class):</span>

<span class="go">    - `required_arguments`: The number of required arguments (default:</span>
<span class="go">      0).</span>

<span class="go">    - `optional_arguments`: The number of optional arguments (default:</span>
<span class="go">      0).</span>

<span class="go">    - `final_argument_whitespace`: A boolean, indicating if the final</span>
<span class="go">      argument may contain whitespace (default: False).</span>

<span class="go">    - `option_spec`: A dictionary, mapping known option names to</span>
<span class="go">      conversion functions such as `int` or `float` (default: {}, no</span>
<span class="go">      options).  Several conversion functions are defined in the</span>
<span class="go">      directives/__init__.py module.</span>

<span class="go">      Option conversion functions take a single parameter, the option</span>
<span class="go">      argument (a string or ``None``), validate it and/or convert it</span>
<span class="go">      to the appropriate form.  Conversion functions may raise</span>
<span class="go">      `ValueError` and `TypeError` exceptions.</span>

<span class="go">    - `has_content`: A boolean; True if content is allowed.  Client</span>
<span class="go">      code must handle the case where content is required but not</span>
<span class="go">      supplied (an empty content list will be supplied).</span>

<span class="go">    Arguments are normally single whitespace-separated words.  The</span>
<span class="go">    final argument may contain whitespace and/or newlines if</span>
<span class="go">    `final_argument_whitespace` is True.</span>

<span class="go">    If the form of the arguments is more complex, specify only one</span>
<span class="go">    argument (either required or optional) and set</span>
<span class="go">    `final_argument_whitespace` to True; the client code must do any</span>
<span class="go">    context-sensitive parsing.</span>

<span class="go">    When a directive implementation is being run, the directive class</span>
<span class="go">    is instantiated, and the `run()` method is executed.  During</span>
<span class="go">    instantiation, the following instance variables are set:</span>

<span class="go">    - ``name`` is the directive type or name (string).</span>

<span class="go">    - ``arguments`` is the list of positional arguments (strings).</span>

<span class="go">    - ``options`` is a dictionary mapping option names (strings) to</span>
<span class="go">      values (type depends on option conversion functions; see</span>
<span class="go">      `option_spec` above).</span>

<span class="go">    - ``content`` is a list of strings, the directive content line by line.</span>

<span class="go">    - ``lineno`` is the line number of the first line of the directive.</span>

<span class="go">    - ``content_offset`` is the line offset of the first line of the content from</span>
<span class="go">      the beginning of the current input.  Used when initiating a nested parse.</span>

<span class="go">    - ``block_text`` is a string containing the entire directive.</span>

<span class="go">    - ``state`` is the state which called the directive function.</span>

<span class="go">    - ``state_machine`` is the state machine which controls the state which called</span>
<span class="go">      the directive function.</span>

<span class="go">    Directive functions return a list of nodes which will be inserted</span>
<span class="go">    into the document tree at the point where the directive was</span>
<span class="go">    encountered.  This can be an empty list if there is nothing to</span>
<span class="go">    insert.</span>

<span class="go">    For ordinary directives, the list must contain body elements or</span>
<span class="go">    structural elements.  Some directives are intended specifically</span>
<span class="go">    for substitution definitions, and must return a list of `Text`</span>
<span class="go">    nodes and/or inline elements (suitable for inline insertion, in</span>
<span class="go">    place of the substitution reference).  Such directives must verify</span>
<span class="go">    substitution definition context, typically using code like this::</span>

<span class="go">        if not isinstance(state, states.SubstitutionDef):</span>
<span class="go">            error = state_machine.reporter.error(</span>
<span class="go">                &#39;Invalid context: the &quot;%s&quot; directive can only be used &#39;</span>
<span class="go">                &#39;within a substitution definition.&#39; % (name),</span>
<span class="go">                nodes.literal_block(block_text, block_text), line=lineno)</span>
<span class="go">            return [error]</span>

<span class="go">&gt;&gt;&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="option-conversion-functions">
<h2><a class="toc-backref" href="#id6">Option Conversion Functions</a><a class="headerlink" href="#option-conversion-functions" title="Permalink to this headline">¶</a></h2>
<p>An option specification (<tt class="docutils literal"><span class="pre">Directive.option_spec</span></tt>) must be defined
detailing the options available to the directive.  An option spec is a
mapping of option name to conversion function; conversion functions
are applied to each option value to check validity and convert them to
the expected type.  Python&#8217;s built-in conversion functions are often
usable for this, such as <tt class="docutils literal"><span class="pre">int</span></tt>, <tt class="docutils literal"><span class="pre">float</span></tt>.  Other useful conversion
functions are included in the <tt class="docutils literal"><span class="pre">docutils.parsers.rst.directives</span></tt>
package (in the <tt class="docutils literal"><span class="pre">__init__.py</span></tt> module):</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">flag</span></tt>: For options with no option arguments.  Checks for an
argument (raises <tt class="docutils literal"><span class="pre">ValueError</span></tt> if found), returns <tt class="docutils literal"><span class="pre">None</span></tt> for
valid flag options.</li>
<li><tt class="docutils literal"><span class="pre">unchanged_required</span></tt>: Returns the text argument, unchanged.
Raises <tt class="docutils literal"><span class="pre">ValueError</span></tt> if no argument is found.</li>
<li><tt class="docutils literal"><span class="pre">unchanged</span></tt>: Returns the text argument, unchanged.  Returns an
empty string (&#8220;&#8221;) if no argument is found.</li>
<li><tt class="docutils literal"><span class="pre">path</span></tt>: Returns the path argument unwrapped (with newlines
removed).  Raises <tt class="docutils literal"><span class="pre">ValueError</span></tt> if no argument is found.</li>
<li><tt class="docutils literal"><span class="pre">uri</span></tt>: Returns the URI argument with whitespace removed.  Raises
<tt class="docutils literal"><span class="pre">ValueError</span></tt> if no argument is found.</li>
<li><tt class="docutils literal"><span class="pre">nonnegative_int</span></tt>: Checks for a nonnegative integer argument,
and raises <tt class="docutils literal"><span class="pre">ValueError</span></tt> if not.</li>
<li><tt class="docutils literal"><span class="pre">class_option</span></tt>: Converts the argument into an ID-compatible
string and returns it.  Raises <tt class="docutils literal"><span class="pre">ValueError</span></tt> if no argument is
found.</li>
<li><tt class="docutils literal"><span class="pre">unicode_code</span></tt>: Convert a Unicode character code to a Unicode
character.</li>
<li><tt class="docutils literal"><span class="pre">single_char_or_unicode</span></tt>: A single character is returned as-is.
Unicode characters codes are converted as in <tt class="docutils literal"><span class="pre">unicode_code</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">single_char_or_whitespace_or_unicode</span></tt>: As with
<tt class="docutils literal"><span class="pre">single_char_or_unicode</span></tt>, but &#8220;tab&#8221; and &#8220;space&#8221; are also
supported.</li>
<li><tt class="docutils literal"><span class="pre">positive_int</span></tt>: Converts the argument into an integer.  Raises
ValueError for negative, zero, or non-integer values.</li>
<li><tt class="docutils literal"><span class="pre">positive_int_list</span></tt>: Converts a space- or comma-separated list
of integers into a Python list of integers.  Raises ValueError for
non-positive-integer values.</li>
<li><tt class="docutils literal"><span class="pre">encoding</span></tt>: Verfies the encoding argument by lookup.  Raises
ValueError for unknown encodings.</li>
</ul>
<p>A further utility function, <tt class="docutils literal"><span class="pre">choice</span></tt>, is supplied to enable
options whose argument must be a member of a finite set of possible
values.  A custom conversion function must be written to use it.
For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">directives</span>

<span class="k">def</span> <span class="nf">yesno</span><span class="p">(</span><span class="n">argument</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">directives</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;no&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>For example, here is an option spec for a directive which allows two
options, &#8220;name&#8221; and &#8220;value&#8221;, each with an option argument:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">option_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;name&#39;</span><span class="p">:</span> <span class="n">unchanged</span><span class="p">,</span> <span class="s">&#39;value&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="error-handling">
<h2><a class="toc-backref" href="#id7">Error Handling</a><a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<p>If your directive implementation encounters an error during
processing, you should call <tt class="docutils literal"><span class="pre">self.error()</span></tt> inside the <tt class="docutils literal"><span class="pre">run()</span></tt>
method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">if</span> <span class="n">error_condition</span><span class="p">:</span>
    <span class="k">raise</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s">&#39;Error message.&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">self.error()</span></tt> method will immediately raise an exception that
will be caught by the reStructuredText directive handler.  The
directive handler will then insert an error-level system message in
the document at the place where the directive occurred.</p>
<p>Instead of <tt class="docutils literal"><span class="pre">self.error</span></tt>, you can also use <tt class="docutils literal"><span class="pre">self.severe</span></tt> and
<tt class="docutils literal"><span class="pre">self.warning</span></tt> for more or less severe problems.</p>
<p>If you want to return a system message <em>and</em> document contents, you need to
create the system message yourself instead of using the <tt class="docutils literal"><span class="pre">self.error</span></tt>
convenience method:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c"># Create node(s).</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="c"># Node list to return.</span>
    <span class="n">node_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">node</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">error_condition</span><span class="p">:</span>
         <span class="c"># Create system message.</span>
         <span class="n">error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reporter</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
             <span class="s">&#39;Error in &quot;</span><span class="si">%s</span><span class="s">&quot; directive: Your error message.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
             <span class="n">nodes</span><span class="o">.</span><span class="n">literal_block</span><span class="p">(</span><span class="n">block_text</span><span class="p">,</span> <span class="n">block_text</span><span class="p">),</span> <span class="n">line</span><span class="o">=</span><span class="n">lineno</span><span class="p">)</span>
         <span class="n">node_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">error</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">node_list</span>
</pre></div>
</div>
</div>
<div class="section" id="register-the-directive">
<h2><a class="toc-backref" href="#id8">Register the Directive</a><a class="headerlink" href="#register-the-directive" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">If the directive is a general-use <strong>addition to the Docutils core</strong>,
it must be registered with the parser and language mappings added:</p>
<ol class="arabic simple">
<li>Register the new directive using its canonical name in
<tt class="docutils literal"><span class="pre">docutils/parsers/rst/directives/__init__.py</span></tt>, in the
<tt class="docutils literal"><span class="pre">_directive_registry</span></tt> dictionary.  This allows the
reStructuredText parser to find and use the directive.</li>
<li>Add an entry to the <tt class="docutils literal"><span class="pre">directives</span></tt> dictionary in
<tt class="docutils literal"><span class="pre">docutils/parsers/rst/languages/en.py</span></tt> for the directive, mapping
the English name to the canonical name (both lowercase).  Usually
the English name and the canonical name are the same.</li>
<li>Update all the other language modules as well.  For languages in
which you are proficient, please add translations.  For other
languages, add the English directive name plus &#8220;(translation
required)&#8221;.</li>
</ol>
</li>
<li><p class="first">If the directive is <strong>application-specific</strong>, use the
<tt class="docutils literal"><span class="pre">register_directive</span></tt> function:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">directives</span>
<span class="n">directives</span><span class="o">.</span><span class="n">register_directive</span><span class="p">(</span><span class="n">directive_name</span><span class="p">,</span> <span class="n">directive_class</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="examples">
<h2><a class="toc-backref" href="#id9">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>For the most direct and accurate information, &#8220;Use the Source, Luke!&#8221;.
All standard directives are documented in <a class="reference external" href="../ref/rst/directives.html">reStructuredText
Directives</a>, and the source code implementing them is located in the
<tt class="docutils literal"><span class="pre">docutils/parsers/rst/directives</span></tt> package.  The <tt class="docutils literal"><span class="pre">__init__.py</span></tt>
module contains a mapping of directive name to module and function
name.  Several representative directives are described below.</p>
<div class="section" id="admonitions">
<h3><a class="toc-backref" href="#id10">Admonitions</a><a class="headerlink" href="#admonitions" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="../ref/rst/directives.html#specific-admonitions">Admonition directives</a>, such as &#8220;note&#8221; and &#8220;caution&#8221;, are quite
simple.  They have no directive arguments or options.  Admonition
directive content is interpreted as ordinary reStructuredText.</p>
<p>The resulting document tree for a simple reStructuredText line
&#8220;<tt class="docutils literal"><span class="pre">..</span> <span class="pre">note::</span> <span class="pre">This</span> <span class="pre">is</span> <span class="pre">a</span> <span class="pre">note.</span></tt>&#8221; looks as follows:</p>
<blockquote>
<div><dl class="docutils">
<dt>&lt;note&gt;</dt>
<dd><dl class="first last docutils">
<dt>&lt;paragraph&gt;</dt>
<dd>This is a note.</dd>
</dl>
</dd>
</dl>
</div></blockquote>
<p>The directive class for the &#8220;note&#8221; directive simply derives from a
generic admonition directive class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">Note</span><span class="p">(</span><span class="n">BaseAdmonition</span><span class="p">):</span>

    <span class="n">node_class</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">note</span>
</pre></div>
</div>
<p>Note that the only thing distinguishing the various admonition
directives is the element (node class) generated.  In the code above,
the node class is set as a class attribute and is read by the
<tt class="docutils literal"><span class="pre">run()</span></tt> method of <tt class="docutils literal"><span class="pre">BaseAdmonition</span></tt>, where the actual processing
takes place:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Import Docutils document tree nodes module.</span>
<span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="c"># Import Directive base class.</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span>

<span class="k">class</span> <span class="nc">BaseAdmonition</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>

    <span class="n">required_arguments</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">optional_arguments</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">final_argument_whitespace</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">option_spec</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="n">node_class</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="sd">&quot;&quot;&quot;Subclasses must set this to the appropriate admonition node class.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># Raise an error if the directive does not have contents.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assert_has_content</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="c"># Create the admonition node, to be populated by `nested_parse`.</span>
        <span class="n">admonition_node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_class</span><span class="p">(</span><span class="n">rawsource</span><span class="o">=</span><span class="n">text</span><span class="p">)</span>
        <span class="c"># Parse the directive contents.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">nested_parse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">content_offset</span><span class="p">,</span>
                                <span class="n">admonition_node</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">admonition_node</span><span class="p">]</span>
</pre></div>
</div>
<p>Three things are noteworthy in the <tt class="docutils literal"><span class="pre">run()</span></tt> method above:</p>
<ul class="simple">
<li>The <tt class="docutils literal"><span class="pre">admonition_node</span> <span class="pre">=</span> <span class="pre">self.node_class(text)</span></tt> line creates the
wrapper element, using the class set by the specific admonition
subclasses (as in note, <tt class="docutils literal"><span class="pre">node_class</span> <span class="pre">=</span> <span class="pre">nodes.note</span></tt>).</li>
<li>The call to <tt class="docutils literal"><span class="pre">state.nested_parse()</span></tt> is what does the actual
processing.  It parses the directive content and adds any generated
elements as child elements of <tt class="docutils literal"><span class="pre">admonition_node</span></tt>.</li>
<li>If there was no directive content, the <tt class="docutils literal"><span class="pre">assert_has_content()</span></tt>
convenience method raises an error exception by calling
<tt class="docutils literal"><span class="pre">self.error()</span></tt> (see <a class="reference internal" href="#error-handling">Error Handling</a> above).</li>
</ul>
</div>
<div class="section" id="image">
<h3><a class="toc-backref" href="#id11">&#8220;image&#8221;</a><a class="headerlink" href="#image" title="Permalink to this headline">¶</a></h3>
<p>The &#8220;<a class="reference external" href="../ref/rst/directives.html#image">image</a>&#8221; directive is used to insert a picture into a document.
This directive has one argument, the path to the image file, and
supports several options.  There is no directive content.  Here&#8217;s an
early version of the image directive class:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># Import Docutils document tree nodes module.</span>
<span class="kn">from</span> <span class="nn">docutils</span> <span class="kn">import</span> <span class="n">nodes</span>
<span class="c"># Import ``directives`` module (contains conversion functions).</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">directives</span>
<span class="c"># Import Directive base class.</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="kn">import</span> <span class="n">Directive</span>

<span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="n">argument</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Conversion function for the &quot;align&quot; option.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">directives</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">argument</span><span class="p">,</span> <span class="p">(</span><span class="s">&#39;left&#39;</span><span class="p">,</span> <span class="s">&#39;center&#39;</span><span class="p">,</span> <span class="s">&#39;right&#39;</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="n">Directive</span><span class="p">):</span>

    <span class="n">required_arguments</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">optional_arguments</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">final_argument_whitespace</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">option_spec</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;alt&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">unchanged</span><span class="p">,</span>
                   <span class="s">&#39;height&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">nonnegative_int</span><span class="p">,</span>
                   <span class="s">&#39;width&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">nonnegative_int</span><span class="p">,</span>
                   <span class="s">&#39;scale&#39;</span><span class="p">:</span> <span class="n">directives</span><span class="o">.</span><span class="n">nonnegative_int</span><span class="p">,</span>
                   <span class="s">&#39;align&#39;</span><span class="p">:</span> <span class="n">align</span><span class="p">,</span>
                   <span class="p">}</span>
    <span class="n">has_content</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">directives</span><span class="o">.</span><span class="n">uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">[</span><span class="s">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference</span>
        <span class="n">image_node</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">rawsource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">block_text</span><span class="p">,</span>
                                 <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">image_node</span><span class="p">]</span>
</pre></div>
</div>
<p>Several things are noteworthy in the code above:</p>
<ul class="simple">
<li>The &#8220;image&#8221; directive requires a single argument, which is allowed
to contain whitespace (<tt class="docutils literal"><span class="pre">final_argument_whitespace</span> <span class="pre">=</span> <span class="pre">True</span></tt>).  This
is to allow for long URLs which may span multiple lines.  The first
line of the <tt class="docutils literal"><span class="pre">run()</span></tt> method joins the URL, discarding any embedded
whitespace.</li>
<li>The reference is added to the <tt class="docutils literal"><span class="pre">options</span></tt> dictionary under the
&#8220;uri&#8221; key; this becomes an attribute of the <tt class="docutils literal"><span class="pre">nodes.image</span></tt> element
object.  Any other attributes have already been set explicitly in
the reStructuredText source text.</li>
</ul>
</div>
<div class="section" id="the-pending-element">
<h3><a class="toc-backref" href="#id12">The Pending Element</a><a class="headerlink" href="#the-pending-element" title="Permalink to this headline">¶</a></h3>
<p>Directives that cause actions to be performed <em>after</em> the complete
document tree has been generated can be implemented using a
<tt class="docutils literal"><span class="pre">pending</span></tt> node.  The <tt class="docutils literal"><span class="pre">pending</span></tt> node causes a <a class="reference external" href="../ref/transforms.html">transform</a> to be run
after the document has been parsed.</p>
<p>For an example usage of the <tt class="docutils literal"><span class="pre">pending</span></tt> node, see the implementation
of the <tt class="docutils literal"><span class="pre">contents</span></tt> directive in
<a class="reference external" href="http://docutils.sf.net/docutils/parsers/rst/directives/parts.py">docutils.parsers.rst.directives.parts</a>.</p>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Creating reStructuredText Directives</a><ul>
<li><a class="reference internal" href="#the-directive-class">The Directive Class</a></li>
<li><a class="reference internal" href="#option-conversion-functions">Option Conversion Functions</a></li>
<li><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li><a class="reference internal" href="#register-the-directive">Register the Directive</a></li>
<li><a class="reference internal" href="#examples">Examples</a><ul>
<li><a class="reference internal" href="#admonitions">Admonitions</a></li>
<li><a class="reference internal" href="#image">&#8220;image&#8221;</a></li>
<li><a class="reference internal" href="#the-pending-element">The Pending Element</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../../_sources/docs/howto/rst-directives.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../index.html">klb3713&#39;s notebook</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, klb3713.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>